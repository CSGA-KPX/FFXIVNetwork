// 在 http://fsharp.org 上了解有关 F# 的详细信息。请参见“F# 教程”项目
// 获取有关 F# 编程的更多指导。
#r @"Z:\KPX\Documents\Visual Studio 2017\Projects\FFXIVNetwork\packages\NLog.4.4.10\lib\net45\NLog.dll"
#load "Utils.fs"
#load "Constants.fs"
#load "GeneralPacket.fs"
#load "SpecializedPacket.fs"
//#load "DevUtils.fs"

open System
open System.IO
open LibFFXIV.GeneralPacket
open LibFFXIV.SpecializedPacket
open LibFFXIV.Utils


let PacketHandler (bytes : byte []) = 
    let packet = FFXIVBasePacket.ParseFromBytes(bytes)
    for sp in packet.SubPackets do
        if sp.Type = 0x0003us then
            let gp = FFXIVGamePacket.ParseFromBytes(sp.Data)
            let OpHex = HexString.ToHex(BitConverter.GetBytes(gp.Opcode))
            printfn "OP:%s Data:%s" (OpHex) (HexString.ToHex(gp.Data))


let LowPacketLog () = 
    let path = @"Z:\KPX\Documents\Visual Studio 2017\Projects\FFXIVNetwork\FFXIVNetwork\bin\Debug\LoggingLowPacket.txt"
    File.ReadAllLines(path)
    |> Array.filter (fun x -> x.ToUpper().StartsWith(LibFFXIV.Constants.FFXIVBasePacketMagic))
    |> Array.map (fun x -> HexString.ToBytes(x))

//LowPacketLog
//|> Array.iter (fun x -> PacketHandler(x))
// 在此处定义库脚本代码


let UnencPacket = "5252A041FF5D46E27F2A644D7B99C4755A8ED88C5C0100006002000000000100010000000000000038020000B8E602E0B8E602E003000000676DD03C5C9FA0F98BB84163B0938F3AA483B574B2F233AA582970E9B9C775038696B6DAC409185E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E51CEF27A84BAA36E0000000000000000"

let p = PacketHandler(HexString.ToBytes(UnencPacket))