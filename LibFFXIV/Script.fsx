// 在 http://fsharp.org 上了解有关 F# 的详细信息。请参见“F# 教程”项目
// 获取有关 F# 编程的更多指导。
#r @"Z:\KPX\Documents\Visual Studio 2017\Projects\FFXIVNetwork\packages\NLog.4.4.10\lib\net45\NLog.dll"
#load "Utils.fs"
#load "Constants.fs"
#load "GeneralPacket.fs"
#load "SpecializedPacket.fs"
//#load "DevUtils.fs"

open System
open System.IO
open LibFFXIV.GeneralPacket
open LibFFXIV.SpecializedPacket
open LibFFXIV.Utils


let PacketHandler (bytes : byte []) = 
    let packet = FFXIVBasePacket.ParseFromBytes(bytes)
    for sp in packet.SubPackets do
        if sp.Type = 0x0003us then
            let gp = FFXIVGamePacket.ParseFromBytes(sp.Data)
            let OpHex = HexString.ToHex(BitConverter.GetBytes(gp.Opcode))
            printfn "OP:%s Data:%s" (OpHex) (HexString.ToHex(gp.Data))


let LowPacketLog () = 
    let path = @"Z:\KPX\Documents\Visual Studio 2017\Projects\FFXIVNetwork\FFXIVNetwork\bin\Debug\LoggingLowPacket.txt"
    File.ReadAllLines(path)
    |> Array.filter (fun x -> x.ToUpper().StartsWith(LibFFXIV.Constants.FFXIVBasePacketMagic))
    |> Array.map (fun x -> HexString.ToBytes(x))

//LowPacketLog
//|> Array.iter (fun x -> PacketHandler(x))
// 在此处定义库脚本代码


let hex = "5252A041FF5D46E27F2A644D7B99C4751047C28D5C010000DA04000000001E000101000000000000789CA5565D681C55143EF7677627DB9A0CF9AF5433D148054BA3E0438DADBBFD91040A66154A8918B31641C19FE4A1424CD2EC648D4989AD892224F8602B112DF4A13E88F5419391D2E6A1D836A02868494240429B341B02DD8DDDDDEBB9B33FC9EC64B3A139C3BD7BE6DCEFFCDC73CF3DB3E70980EB2ED1E460F0DB47A5F02E4A9E601D93754D80D422E657BE13533784F7CEB5A500942DC44B066F7B2F88A9EE70ED2D00D6EE0DC34E098497BF2F9A12620939AF68ABFABB0B99CB5D15AD73DB00DE3359EBB032762901ECECCC1CBC3034106D1422D1191D14428449B433417A8647CDA7AEB7044CD6DBE88B9195C872EDC58F4F5EBB15AE12065A724F075B12BCF5B42F38465047C4719845422C4682B158B794887B6E9C220937795E88FB37A69994258E07CDC27E094C530C8D99D08DF329626840B90E65678600C8CA6814338172C307256180766B531006F617C6B87F7141D07EB4338E261E1597931124C6A5C99E0846E8DAF95C2F6C81D08EBED17A03649F5387ED9C364BA6C3CEFB5976048E1F5F951C2EC0EFBD69EEC07472B500FEE8754B6ECCE26690C3FCFDCB20915206E8C4316C71011C8D16B78CE3A4C51938DC16D78A63CCE2E2A9D00082192B1213C984C42CEEF89C23FEB6EC3C683E78CC071CB937264A1FDF8B8ADC122757C961AD0611C8E86A8DE6071DFC6AE501D257B95D9BDF8D98E8B678C07D25A6AA2AC06DAE79C509603741A5584F2633818CC7CD64C15FD971BD0DC3B2B202AA3DCBAA755E00A1E46BE15E78C8D8E050D6A1B71DFBBC6ADB67A45F84670EADAF6B157A90AC9578335C95983A26991DB9FC4CD8FC887E211ED44F9014254B07E969879F769B1FA2109578C876923A2727DE6DC39B67EA9ADEF4AC7A7ED28197377D15CFA0C023F14E9CCB1E07EC2A90B88003476CB860D477D7FB67F09DC59F9683F72E7EFDC12F573F094DE823F5E79EA9F9D980EA0AC5445BB5F10530ACE28352005F2658AC2BE77D067BDEA7D39375017BD63F01801147FFE6363B27B46F52C8645E89067EF82164640CC8A8D86A7F1411D9E3F6073A56C4BC1FA05AD52189A507351705F815B0FFDEDF9538D6F562E820D18AB1873684F536FDDB40597C697280F6C7E030C1FA3786E49510775C5FA02AE81ABC34AB1D79B8DC0DBE1A7FDAB52C8D96A1F398A9A294E49C9CDC4D67CB2793EF3419E052D948D6B6F55CF970922FED2DB5E7C26EFEA5265DFB34D9EBD712C57B6E501D548382D95B25FA421A46A085B847ADAD3EFD9609E550C203A1CF744F1F1AABDC9DDA05851503B2085B43D6B930FBF986D3D374D8F69A356D969C752D5BAAFDFB200D9A0E5CC286231C1F4A093E0CF78E03054CC177C970C025461589E1C0B8C2F05A207114298428481C38C7754A41A19CE10265840225528686642FA6545118B2C0F197231451C029419B1266F957384339DA205CB67ED4008C822B3E47FC876C791DC45AD672E4E891A60F9FCDA73F84FA37E7AA5F7950FDCF31D8CA1CFEFDA35F0DE4D3BFC47334DB14E5D3FF149A6773E93242583EFD41C8B46C271196D7FF6B6C7DFFFFE16838D23C9B4FBF798BFA2D39F46193FAAF6FD17F208F7FE777ADC2A65FB16F1FEC4BE18DBA8275BE83B235DAEF7531FEC72A7625F9530EFC3F0EFC5A4A775E8FA8DF73744FAEC89D547F74E3F5FF01C24D50165252A041FF5D46E27F2A644D7B99C4751247C28D5C01000058000000000001000101000000000000789C33606060607BC72800C2CC0C679B4518C41919185499AB2E5A4502A518C46D6C186C1820A0C18A930100CAC5074E"
let hex2= "5252A041FF5D46E27F2A644D7B99C4753882B2905C0100005E000000000001000101000000000000789CB3606060F8F691C181ED1DA3003343FD0B11062746060631069E49D6914029063620CE0963150061062830EC65600000395508E0"
let bytes = hex2 |> HexString.ToBytes

let packetSize = FFXIVBasePacket.GetPacketSize(bytes)


let rec yieldPacket (rest) = 
    let rst = FFXIVBasePacket.TakePacket(rest)
    if rst.IsNone then
        rest
    else
        let (p, rst) = rst.Value
        printfn "%A" (FFXIVBasePacket.ParseFromBytes(p))
        yieldPacket(rst)
let rst = yieldPacket(bytes)
if rst.Length <> 0 then
    rst |> HexString.ToHex |> printfn "%s"